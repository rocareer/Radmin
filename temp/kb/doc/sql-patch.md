# 知识库数据库结构补丁

## 补丁文件

### 1. 增量补丁文件
**文件路径**: `/temp/kb/sql/patch_category_tag.sql`

**适用场景**: 在现有数据库基础上添加缺失字段

**主要修改**:
- 为 `ra_kb_category` 表添加状态、排序、时间字段
- 为 `ra_kb_tag` 表添加排序字段
- 添加相应索引优化查询性能
- 兼容现有数据，自动设置默认值

### 2. 完整结构文件
**文件路径**: `/temp/kb/sql/r251124_updated.sql`

**适用场景**: 全新部署或完整重建数据库结构

**包含内容**: 所有知识库相关表的完整结构定义

## 具体修改内容

### ra_kb_category 表新增字段

| 字段名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| status | tinyint unsigned | 1 | 状态:0=禁用,1=启用 |
| sort | int | 0 | 排序 |
| create_time | bigint unsigned | NULL | 创建时间 |
| update_time | bigint unsigned | NULL | 更新时间 |

### ra_kb_tag 表新增字段

| 字段名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| sort | int | 0 | 排序 |

### 新增索引

**ra_kb_category 表**:
- `idx_status` (status)
- `idx_sort` (sort) 
- `idx_create_time` (create_time)

**ra_kb_tag 表**:
- `idx_sort` (sort)

## 使用方法

### 方法一：使用增量补丁（推荐）
```sql
-- 执行增量补丁
SOURCE /path/to/patch_category_tag.sql;
```

### 方法二：使用完整结构
```sql
-- 备份现有数据
-- 删除现有表
-- 执行完整结构
SOURCE /path/to/r251124_updated.sql;
-- 恢复数据
```

## 数据兼容性

### 现有数据处理
- **分类表**: 自动为现有记录设置默认状态(启用)、排序(0)、创建时间
- **标签表**: 自动为现有记录设置默认排序(0)
- **数据安全**: 补丁执行前会自动处理NULL值，确保数据完整性

### 默认值策略
- **状态字段**: 默认为启用(1)，符合业务预期
- **排序字段**: 默认为0，支持后续自定义排序
- **时间字段**: 现有数据会设置为当前时间戳

## 前端对应修改

前端模板已同步更新，支持新增字段：

### 分类页面
- ✅ 状态 switch 开关
- ✅ 排序数字输入框
- ✅ 创建时间显示

### 标签页面  
- ✅ 排序数字输入框
- ✅ 保持原有颜色、状态、使用统计功能

## 注意事项

1. **备份数据**: 执行补丁前请备份相关表数据
2. **权限检查**: 确保数据库用户有 ALTER 权限
3. **测试环境**: 建议先在测试环境验证补丁
4. **索引优化**: 新增索引可能影响写入性能，但大幅提升查询效率

## 版本信息

- **补丁版本**: v1.0
- **创建时间**: 2025-11-25
- **兼容版本**: MySQL 5.7+
- **字符集**: utf8mb4_unicode_ci